<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8"/>
    <title>JSON 编辑器互动示例</title>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.14.0/src-noconflict/ace.js"></script>
    <script src="./polyfills/assign.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="./scripts/ajv-validator.js"></script>
    <script src="随机数据.js"></script>
    <link rel='stylesheet' id='theme-link'>
    <link rel='stylesheet' id='iconlib-link'>
</head>
<body>

<div class="container grid-xl" style="padding-top: 15px; padding-bottom: 30px;">
    <div class="row columns md:flex">
        <div class='col-7 col-md-7 w-7/12'>
            <h1>编辑器</h1>
            <p>下面是从 JSON 模式生成的编辑器。</p>
            <div id="json-editor-form"></div>

        </div>
        <div class='col-5 col-md-5 w-5/12'>
            <div>
                <a class="btn btn-primary" id="direct-link" title="保留模式、值和选项">直接链接</a>
                <a class="btn btn-secondary" href="?" title="使用默认示例设置重新加载编辑器">重置</a>
                <a class="btn btn-secondary" href="https://github.com/json-editor/json-editor" title="GitHub"
                   target="_blank">GitHub</a>
            </div>
            <h2>JSON 输出</h2>
            <p>您还可以在这里更改 JSON 并通过点击“更新表单”设置编辑器中的值。</p>
            <label for="output-textarea"></label>
            <button class='btn btn-primary btn-block' id='setvalue'>更新表单</button>
            <textarea id='output-textarea' rows="15" style="width: 100%; font-family: monospace;"
                      class='form-control'></textarea>
            <h2>验证</h2>
            <label for="validate-textarea">每当表单发生变化时，这将更新以显示是否有任何验证错误。</label><br>
            <textarea id='validate-textarea' readonly disabled class='form-control'></textarea>
            <h2>选项</h2>
            <div>
                <label for="boolean-options-select">布尔选项</label><br>
                <select multiple size="15" id="boolean-options-select" class="form-control browser-default">
                    <option value='use_default_values'>基于“类型”的默认值</option>
                    <option value='use_name_attributes'>使用名称属性</option>
                    <option value='prompt_before_delete'>删除前提示</option>
                    <option value='case_sensitive_property_search'>区分大小写的属性搜索</option>
                    <option value='required_by_default'>默认情况下对象属性是必需的</option>
                    <option value='display_required_only'>默认情况下仅显示必需属性</option>
                    <option value='show_opt_in'>显示可选属性（带复选框）</option>
                    <option value='no_additional_properties'>不允许额外的对象属性</option>
                    <option value='ajax'>允许通过Ajax加载模式</option>
                    <option value='disable_edit_json'>禁用“编辑 JSON”按钮</option>
                    <option value='disable_collapse'>禁用折叠按钮</option>
                    <option value='disable_properties'>禁用属性按钮</option>
                    <option value='disable_array_add'>禁用数组添加按钮</option>
                    <option value='disable_array_reorder'>禁用数组移动按钮</option>
                    <option value='disable_array_delete'>禁用数组删除按钮</option>
                    <option value='enable_array_copy'>为数组添加复制按钮</option>
                    <option value='array_controls_top'>数组控件将显示在列表顶部</option>
                    <option value='disable_array_delete_all_rows'>禁用数组删除所有行按钮</option>
                    <option value='disable_array_delete_last_row'>禁用数组删除最后一行按钮</option>
                </select>
            </div>
            <div>
                <label for="theme-select">主题</label><br>
                <select id='theme-select' name="theme" class='form-control browser-default'>
                    <option value='barebones'>简单</option>
                    <option value='bootstrap3'>Bootstrap 3</option>
                    <option value='bootstrap4'>Bootstrap 4</option>
                    <option value='bootstrap5'>Bootstrap 5</option>
                    <option value='html'>HTML</option>
                    <option value='spectre'>Spectre</option>
                    <option value='tailwind'>Tailwind</option>
                </select>
            </div>
            <div>
                <label for="iconlib-select">图标库</label><br>
                <select id='iconlib-select' name="iconlib" class='form-control browser-default'>
                    <option value='fontawesome3'>FontAwesome 3</option>
                    <option value='fontawesome4'>FontAwesome 4</option>
                    <option value='fontawesome5'>FontAwesome 5</option>
                    <option value='jqueryui'>jQuery UI</option>
                    <option value='openiconic'>Open Iconic</option>
                    <option value='spectre'>Spectre</option>
                    <option value='bootstrap'>Bootstrap</option>
                </select>
            </div>
            <div>
                <label for="object-layout-select">对象布局</label><br>
                <select id='object-layout-select' class='form-control browser-default'>
                    <option value='normal'>正常</option>
                    <option value='grid'>网格</option>
                </select>
            </div>
            <div>
                <label for="show-errors-select">显示错误</label><br>
                <select id='show-errors-select' class='form-control browser-default'>
                    <option value='interaction'>交互时</option>
                    <option value='change'>字段更改时</option>
                    <option value='always'>总是</option>
                    <option value='never'>从不</option>
                </select>
            </div>
            <div>
                <label for="lib-select"
                       title="建议您在更改这些选项后单击直接链接">包含外部库</label><br>
                <select multiple size="10" id='lib-select' class='form-control browser-default'
                        title="建议您在更改这些选项后单击直接链接">
                    <option value='ace_editor'>Ace 编辑器</option>
                    <option value='choices'>Choices</option>
                    <option value='sceditor'>SCEditor</option>
                    <option value='simplemde'>SimpleMDE</option>
                    <option value='select2'>Select2</option>
                    <option value='selectize'>Selectize</option>
                    <option value='flatpickr'>Flatpickr</option>
                    <option value='signature_pad'>Signature Pad</option>
                    <option value='mathjs'>Math.js</option>
                    <option value='cleavejs'>Cleave.js</option>
                </select>
            </div>
        </div>
    </div>

    <h2>模式</h2>

    <div class="row columns md:flex">
        <div class='col-7 col-md-7 w-7/12'>
            <label for="schema-textarea">您可以更改模式并查看生成的表单外观。完成更改后，单击“更新模式”</label>
            <button class='btn btn-primary btn-block' id='setschema'>更新模式</button>

            <textarea id='schema-textarea' style="height: 100vh;"></textarea>
        </div>

        <div class='col-5 col-md-5 w-5/12'>
            <label for="je-errors-textarea">
                <span>AJV（JE 元模式）： </span>
                <code id="je-errors-count"></code>
            </label>
            <textarea id='je-errors-textarea'></textarea>

            <br>

            <label for="ajv-errors-textarea">
                <span>AJV（元模式-2020-12）： </span>
                <code id="ajv-errors-count"></code>
            </label>
            <textarea id='ajv-errors-textarea'></textarea>
        </div>
    </div>
</div>
<script>
    var defaultSchema = {
  'title': '节点',
  'type': 'object',
  'required': [
    '名称',
    '帮助',
    '最后修改日期',
    '参数',
    '示例'
  ],
  'properties': {
    '名称': {
      'type': 'string',
      'default': '默认名称',
      'minLength': 4,
      'maxLength': 60,
      'options': {
        'hidden': false,
        'inputAttributes': {
          'placeholder': '输入名称'
        }
      }
    },
    '帮助': {
      'type': 'string',
      'default': '帮助信息'
    },
    '最后修改日期': {
      'type': 'string',
      'format': 'date'
    },
    '参数': {
      'title': '节点参数',
      'type': 'array',
      'format': 'table',
      'uniqueItems': true,
      'items': {
        'type': 'object',
        'properties': {
          '参数': {
            'type': 'string',
            'default': '默认参数'
          },
          '单位': {
            'type': 'string',
            'default': '单位'
          },
          '类型': {
            'type': 'string',
            'enum': [
              '字符串',
              '双精度',
              '布尔',
              '整数'
            ]
          },
          '参数名称': {
            'type': 'string'
          },
          '值': {
            'type': 'string'
          },
          '子参数': {
            'title': '子参数',
            'type': 'array',
            'format': 'table',
            'items': {
              'type': 'object',
              'properties': {
                '子参数': {
                  'type': 'string'
                },
                '子参数值': {
                  'type': 'string'
                }
              }
            }
          }
        }
      }
    },
    '示例': {
      'title': '示例JSON数据',
      'type': 'object',
      'properties': {
        '输入': {
          'title': '输入',
          'type': 'string',
          'default': '输入示例'
        },
        '输出': {
          'title': '输出',
          'type': 'string',
          'default': '输出示例'
        }
      }
    }
  }
}


    // parse url -> merge options -> refreshUI() -> initJsoneditor() -> direct link

    /* ------------------------------------------------------------------- data */

    var data = {}

    var defaultOptions = Object.assign({}, JSONEditor.defaults.options, {
        iconlib: 'fontawesome5',
        object_layout: 'normal',
        schema: defaultSchema,
        show_errors: 'interaction',
        theme: 'bootstrap4',
    })

    var jsoneditor = null
    var directLink = document.querySelector('#direct-link')

    var booleanOptionsSelect = document.querySelector('#boolean-options-select')
    var head = document.getElementsByTagName('head')[0]
    var iconlibSelect = document.querySelector('#iconlib-select')
    var iconlibLink = document.querySelector('#iconlib-link')
    var libSelect = document.querySelector('#lib-select')
    var jsonEditorForm = document.querySelector('#json-editor-form')
    var objectLayoutSelect = document.querySelector('#object-layout-select')
    var setSchema = document.querySelector('#setschema')
    var setValue = document.querySelector('#setvalue')
    var showErrorsSelect = document.querySelector('#show-errors-select')
    var themeSelect = document.querySelector('#theme-select')
    var themeLink = document.querySelector('#theme-link')
    var validateTextarea = document.querySelector('#validate-textarea')

    var aceConfig = {
        mode: 'ace/mode/json',
        maxLines: Infinity,
        minLines: 5,
        showFoldWidgets: false,
        showPrintMargin: false
    }

    var outputTextarea = ace.edit('output-textarea', aceConfig)
    var schemaTextarea = ace.edit('schema-textarea', aceConfig)
    var ajvErrorsTextarea = ace.edit('ajv-errors-textarea', aceConfig)
    var jeErrorsTextarea = ace.edit('je-errors-textarea', aceConfig)
    var ajvErrorsCount = document.querySelector('#ajv-errors-count')
    var jeErrorsCount = document.querySelector('#je-errors-count')
    var ajv = new AjvValidator()

    const validateSchema = () => {
        const dataToValidate = JSON.parse(schemaTextarea.getValue())
        let errors

        // AJV validation
        ajvErrorsCount.textContent = '0'
        errors = ajv.validate202012(dataToValidate)
        ajvErrorsTextarea.setValue(JSON.stringify(errors, null, 2))
        ajvErrorsCount.textContent = JSON.stringify(errors.length)
        schemaTextarea.clearSelection(1)
        ajvErrorsTextarea.clearSelection(1)

        // JE validation with AJV
        jeErrorsCount.textContent = '0'
        errors = ajv.validateJeMetaSchema(dataToValidate)
        jeErrorsTextarea.setValue(JSON.stringify(errors, null, 2))
        jeErrorsCount.textContent = JSON.stringify(errors.length)
        schemaTextarea.clearSelection(1)
        jeErrorsTextarea.clearSelection(1)
    }

    /* -------------------------------------------------------------- parse url */

    var parseUrl = function () {
        var url = window.location.search
        var queryParamsString = url.substring(1, url.length)
        var queryParams = queryParamsString.split('&')

        if (queryParamsString.length) {
            queryParams.forEach(function (queryParam) {
                var splittedParam = queryParam.split('=')
                var param = splittedParam[0]
                var value = splittedParam[1]

                // data query param
                if (param === 'data') {
                    // compress schema and value
                    try {
                        data = JSON.parse(LZString.decompressFromBase64(value))
                    } catch (reason) {
                    }
                }
            })
        }

        mergeOptions()
    }

    /* ----------------------------------------------------------- mergeOptions */

    var mergeOptions = function () {
        data.options = Object.assign(defaultOptions, data.options)
        refreshUI()
    }

    /* -------------------------------------------------------------- refreshUI */

    var refreshUI = function () {
        // schema
        schemaTextarea.setValue(JSON.stringify(data.options.schema, null, 2))
        schemaTextarea.clearSelection(1)
        validateSchema()

        // theme
        var themeMap = {
            barebones: '',
            bootstrap3: 'https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css',
            bootstrap4: 'https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css',
            bootstrap5: 'https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css',
            html: '',
            spectre: 'https://unpkg.com/spectre.css/dist/spectre.min.css',
            tailwind: 'https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css'
        }
        themeLink.href = themeMap[data.options.theme]
        themeSelect.value = data.options.theme

        // iconlLib
        var iconLibMap = {
            fontawesome3: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.css',
            fontawesome4: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css',
            fontawesome5: 'https://use.fontawesome.com/releases/v5.6.1/css/all.css',
            jqueryui: 'https://code.jquery.com/ui/1.10.3/themes/south-street/jquery-ui.css',
            openiconic: 'https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic.min.css',
            spectre: 'https://unpkg.com/spectre.css/dist/spectre-icons.min.css',
            bootstrap: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css'
        }
        iconlibLink.href = iconLibMap[data.options.iconlib]
        iconlibSelect.value = data.options.iconlib

        // object_layout
        objectLayoutSelect.value = data.options.object_layout

        // show_errors
        showErrorsSelect.value = data.options.show_errors

        // boolean values
        var booleanOptions = booleanOptionsSelect.children
        for (var i = 0; i < booleanOptions.length; i++) {
            var booleanValue = booleanOptions[i]
            if (data.options[booleanValue.value]) {
                booleanValue.selected = true
            }
        }

        // libs
        var libMapping = {
            ace_editor: {
                js: [
                    'https://cdn.jsdelivr.net/npm/ace-editor-builds@1.2.4/src-min-noconflict/ace.js'
                ],
                css: []
            },
            choices: {
                js: [
                    'https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js'
                ],
                css: [
                    'https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css'
                ]
            },
            cleavejs: {
                js: [
                    'https://cdn.jsdelivr.net/npm/cleave.js@1.4.7/dist/cleave.min.js'
                ],
                css: []
            },
            sceditor: {
                js: [
                    'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js',
                    'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/sceditor.min.js',
                    'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/formats/bbcode.js',
                    'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/formats/xhtml.js'
                ],
                css: [
                    'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/themes/default.min.css'
                ]
            },
            simplemde: {
                js: [
                    'https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js'
                ],
                css: [
                    'https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css'
                ]
            },
            select2: {
                js: [
                    'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js',
                    'https://cdn.jsdelivr.net/npm/select2@4.0.6-rc.1/dist/js/select2.min.js'
                ],
                css: [
                    'https://cdn.jsdelivr.net/npm/select2@4.0.6-rc.1/dist/css/select2.min.css'
                ]
            },
            selectize: {
                js: [
                    'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js',
                    'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js'
                ],
                css: [
                    'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.min.css',
                    'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.min.css'
                ]
            },
            flatpickr: {
                js: [
                    'https://cdn.jsdelivr.net/npm/flatpickr'
                ],
                css: [
                    'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css'
                ]
            },
            signature_pad: {
                js: [
                    'https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js'
                ],
                css: []
            },
            mathjs: {
                js: [
                    'https://cdn.jsdelivr.net/npm/mathjs@5.3.1/dist/math.min.js'
                ],
                css: []
            },
        }

        if (data.selectedLibs || data.unselectedLibs) {

            var booleanOptions = booleanOptionsSelect.children
            for (var i = 0; i < booleanOptions.length; i++) {
                var booleanValue = booleanOptions[i]
                if (data.options[booleanValue.value]) {
                    booleanValue.selected = true
                }
            }

            var libSelectChildren = libSelect.children
            for (var i = 0; i < libSelectChildren.length; i++) {
                var child = libSelectChildren[i]
                child.selected = data.selectedLibs.includes(child.value)
            }

            // remove libraries
            data.unselectedLibs.forEach(function (selectedLib) {
                var concat = libMapping[selectedLib].js.concat(libMapping[selectedLib].css)
                concat.forEach(function () {
                    var className = '.external_' + selectedLib
                    var toRemove = head.querySelector(className)
                    if (toRemove) {
                        toRemove.parentNode.removeChild(toRemove)
                    }
                })
            })

            // add libraries
            data.selectedLibs.forEach(function (selectedLib) {
                // add js
                libMapping[selectedLib].js.forEach(function (js) {
                    var scriptElement = document.createElement('script')
                    scriptElement.type = 'text/javascript'
                    scriptElement.src = js
                    scriptElement.async = false
                    scriptElement.classList.add('external_' + selectedLib)
                    head.appendChild(scriptElement)
                })
                // add css
                libMapping[selectedLib].css.forEach(function (css) {
                    var linkElement = document.createElement('link')
                    linkElement.setAttribute('rel', 'stylesheet')
                    linkElement.setAttribute('type', 'text/css')
                    linkElement.setAttribute('href', css)
                    linkElement.classList.add('external_' + selectedLib)
                    head.appendChild(linkElement)
                })
            })
        }

        initJsoneditor()
    }

    /* --------------------------------------------------------- initJsoneditor */

    var initJsoneditor = function () {
        // destroy old JSONEditor instance if exists
        if (jsoneditor) {
            jsoneditor.destroy()
        }

        // new instance of JSONEditor
        jsoneditor = new window.JSONEditor(jsonEditorForm, data.options)

        // listen for changes
        jsoneditor.on('change', function () {
            // output
            var json = jsoneditor.getValue()
            outputTextarea.setValue(JSON.stringify(json, null, 2))
            outputTextarea.clearSelection(1)

            // validate
            var validationErrors = jsoneditor.validate()
            if (validationErrors.length) {
                validateTextarea.value = JSON.stringify(validationErrors, null, 2)
            } else {
                validateTextarea.value = 'valid'
            }
        })
        updateDirectLink()
    }

    /* ------------------------------------------------------- updateDirectLink */

    var updateDirectLink = function () {
        var url = window.location.href.replace(/\?.*/, '')
        url += '?data='
        url += LZString.compressToBase64(JSON.stringify(data))
        directLink.href = url
    }

    /* -------------------------------------------------------- event listeners */

    setValue.addEventListener('click', function () {
        jsoneditor.setValue(JSON.parse(outputTextarea.getValue()))
    })

    setSchema.addEventListener('click', function () {
        try {
            data.options.schema = JSON.parse(schemaTextarea.getValue())
            validateSchema()
        } catch (e) {
            alert('Invalid Schema: ' + e.message)
            return
        }
        refreshUI()
    })

    themeSelect.addEventListener('change', function () {
        data.options.theme = this.value || ''
        refreshUI()
    })

    iconlibSelect.addEventListener('change', function () {
        data.options.iconlib = this.value || ''
        refreshUI()
    })

    objectLayoutSelect.addEventListener('change', function () {
        data.options.object_layout = this.value || ''
        refreshUI()
    })

    showErrorsSelect.addEventListener('change', function () {
        data.options.show_errors = this.value || ''
        refreshUI()
    })

    booleanOptionsSelect.addEventListener('change', function () {
        var booleanOptions = this.children
        for (var i = 0; i < booleanOptions.length; i++) {
            data.options[booleanOptions[i].value] = booleanOptions[i].selected
        }
        refreshUI()
    })

    libSelect.addEventListener('change', function () {
        data.selectedLibs = []
        data.unselectedLibs = []

        var libs = this.children

        for (var i = 0; i < libs.length; i++) {
            if (libs[i].selected) {
                data.selectedLibs.push(libs[i].value)
            } else {
                data.unselectedLibs.push(libs[i].value)
            }
        }
        refreshUI()
    })

    parseUrl()

</script>
</body>
</html>
